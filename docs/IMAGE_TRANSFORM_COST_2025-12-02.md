# 画像変換方式のコスト試算 (2025-12-02)

公開ページは SSG、データは CSR Fetch（商品/コレクション/プロフィール/レシピ）の前提で、画像サムネイル変換の月額コストを比較します。

## 前提（共通）
- 月間 PV: 6,000〜8,000
- 初期表示でサムネイル 24 枚/訪問（遅延読込含む） → 配信枚数 ≒ 144k〜192k 画像/月
- 商品画像: 600 枚（R2 に原本保管）
- 変換バリアント: 幅 400px（一覧用）を基本。将来的に 800px（詳細ヘッダ）を追加する可能性あり。
- キャッシュ: 変換済サムネイルは R2/CDN にキャッシュし、初回のみ変換を実行。

## 方式 A: Cloudflare Images（リモート画像の変換のみ利用）
- 参照: Cloudflare Images Pricing（Aug 7, 2025）
  - Free: 5,000 unique transformations/月 まで無料（超過は新規変換 9422 エラー）
  - Paid: Unique Transformations: 最初の5,000含む + 以降 $0.50/1,000 unique/月
  - Images Stored / Delivered は「Cloudflare Images に保存した場合のみ」課金。R2 保管のままなら未適用。

- 想定ユニーク変換数
  - 400px 1バリアント: 600（画像枚数と同数）
  - 400px + 800px 2バリアント: 1,200
  → いずれも Free の 5,000 未満。

- 月額概算
  - Freeプランのまま: $0.00（ユニーク5,000未満、配信は R2/CDN 側で実施）
  - もし将来ユニークが 10,000 に増加した場合（例: 多数のサイズバリアント追加）
    - Paid: (10,000 - 5,000) / 1,000 × $0.50 = $2.50/月

- 特記事項
  - 「配信枚数（Delivered）」は Images に保存していない限り課金対象外。
  - Free 超過時は新規変換が 9422 エラーになるため、閾値近傍では Paid への切替を推奨。

## 方式 B: Cloudflare Images（Images に保存＋Variants 配信）
- 課金要素（Paid）
  - Images Stored: $5/100,000 images stored/月
  - Images Delivered: $1/100,000 delivered/月
- 想定
  - 保存: 600枚 → $5 × (600/100,000) ≈ $0.03/月
  - 配信: 144k〜192k delivered → $1 × (1.44〜1.92) ≈ $1.44〜$1.92/月
- 月額概算
  - 合計 ≈ $1.47〜$1.95/月（変換費用は Delivered 側に内包されるため、Transformations 課金は原則発生しない）
- 特記事項
  - 画像の保管先を R2 → Images に切替える必要あり（または二重管理）。
  - 料金は小さいが、運用切替の手間が増える。

## 方式 C: Workers + WASM Sharp（R2 にサムネイル保存）
- 課金前提
  - 変換処理は Workers Free（CPU 10ms/req 上限）では現実的に厳しいため、Workers Paid（Standard）想定。
  - Workers Paid: $5/月（含まれる 3,000万 CPU ms と 1,000万 req は今回規模では十分）
  - R2: 生成サムネイル保管・配信はほぼ Free 範囲内（Storage/Op は微小）。
- 想定ユニーク変換数と CPU
  - 初回変換: 600〜1,200 回/月（100ms/回 仮定）→ 60,000〜120,000 CPU ms/月（含有 30,000,000 ms 内）
- 月額概算
  - Workers 基本料: $5.00
  - R2 超過: $0.00（概ね Free 内）
  - 合計: $5.00/月
- 特記事項
  - オンデマンドで高度な加工（合成・透過・ウォーターマーク等）が可能。
  - 実装/保守コストは最も高い（WASMパッケージ、エラー/タイムアウト制御、最適化）。

## 比較表（USD）
| 方式 | 保管 | 変換課金 | 配信課金 | 月額目安 | 運用/実装コスト |
|---|---|---|---|---:|---|
| A Images Transform（R2原本） | R2 | Free ≤5k unique（超: $0.50/1k） | なし（R2配信） | $0.00（現状） | 低（URL生成のみ） |
| B Images（保存＋配信） | Images | Delivered 課金に内包 | $1/100k delivered | $1.47〜$1.95 | 中（保管切替・Variants管理） |
| C Workers+WASM+R2 | R2 | Workers Paid $5/月 | なし（R2配信） | $5.00 | 高（実装・保守） |

## 結論 / 推奨
- 現状規模（600枚・バリアント1〜2種）なら、
  - 最小コスト: 方式 A（Cloudflare Images Transform を Free で利用）→ $0/月
  - 運用簡素＋課金のわかりやすさを重視するなら: 方式 B（Images に保存）→ ~$2/月
  - 高度な独自加工や将来の特殊処理要件が明確: 方式 C（Workers WASM）→ $5/月

- 即決おすすめ: 方式 A（Free 運用）で開始し、以下を監視:
  - 「ユニーク変換数」> 5,000/月 になりそう → Paid へ（$0.50/1,000）
  - 運用をさらに単純化したい → 方式 B へ移行（~$2/月）
  - 高機能加工の要求が出た → 方式 C を PoC のうえ採用

## メモ
- 数値は Cloudflare 公開ドキュメント（Images Pricing, 2025-08-07）に基づく。R2/Workers は既存の試算と同一前提。
- 将来 PV/画像数/バリアント数が増加した場合は、閾値（5,000 unique/月、Delivered スループット）を再評価。
