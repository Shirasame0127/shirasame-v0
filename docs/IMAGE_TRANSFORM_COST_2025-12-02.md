## 補足: `sharp` を使う場合（即時最適化・即時サムネ生成をサーバ側で行う）
以下は、管理サーバ側で `sharp`（ネイティブ画像処理）を利用してアップロード時に変換とサムネを即時生成する運用に切り替えた場合の具体的な挙動とコスト影響です。前節の前提（PV 6k-8k、商品画像600枚、変換バリアント 400px / 将来 800px）をそのまま使って評価します。

1) 動作の違い（実例）
  - 現状: 初回表示で必要なサムネが無ければ CDN/R2 の原寸を読み込むケースがある。
  - sharp 導入時: 管理画面の `upload` API が受け取った原本を即時に最適化（AVIF/WebP/JPEG のいずれか）し、40/100/400（+detail-800 等）を生成して R2 に書き込み、`images` テーブルに `thumbnails` として保存する。公開ページは必ず `thumbnails['400']` を参照する想定。これにより初回表示時の余分な変換や原寸読み込みを防げます。

2) 必要なランタイム／実行環境
  - `sharp` はネイティブ依存（libvips）を持つため、Cloudflare Pages の Functions（Worker ランタイム）ではそのままは動作しない可能性が高い。
  - 動かす選択肢:
    - Workers + WASM（sharp 相当を WASM 化して動かす／既存の実装を移植）: Workers Paid が必要な場合がある（下記コスト参照）。
    - Node 実行可能なホスティング（Vercel Serverless Node / Cloud Run / VPS）: `sharp` を通常に動かせる。運用が簡単。

3) コスト試算（追加分・月額概算）
  - 想定ユニーク変換数: 600 画像 × 1 バリアント（400px） = 600（現状）。将来的に 2 バリアントで 1,200。
  - 1件あたり処理時間想定（CPU）: 50–150 ms（画像サイズや変換内容に依存）。保守的に 100ms を採用。
  - 月間 CPU ms 想定: 600 件 × 100ms = 60,000 ms（0.06 s × 600 = 60s）。非常に小さい。

  選択肢別概算（現行想定範囲）:
  - Workers + WASM（変換をエッジで行う）: Workers Paid 月額 $5（標準プラン）で十分。今回の変換量だと追加課金は発生しにくい。合計見積: **+$5/月**（おおむね）。
  - Cloud Run / Vercel Server (Node + sharp): 小規模（オンデマンド）ならインスタンス時間は少なく、Cloud Run の最小構成で **約 $5–$20 / 月** のレンジが現実的（常時稼働やピークで上下）。Vercel の場合、Serverless 実行時間により課金が発生するため無料枠内で収まるかはユース次第。
  - 小型 VPS（例: $5/月 のプラン）: 常時稼働で $5/月 程度。セットアップと運用監視の手間が必要。

  参考: 変換コストは画像変換そのものより「変換を動かす環境の維持費」が主で、今回の規模では $0–$20/月 の差分が目安です。Cloudflare Images の変換課金（unique transforms 超過）に比べて、sharp を自前で回す場合は低負荷だと安価に済みますが、実装・保守が増えます。

4) 運用上のメリット/デメリット
  - メリット: 初回から最適化済みのサムネを配信できるため LCP（Largest Contentful Paint）や UX が安定して改善。キャッシュの効率化が進む。
  - デメリット: 実行環境の準備と native module のビルド・セキュリティ運用が必要。Pages を採用する場合は外部サービス化（Cloud Run/VPS/Worker）を検討する必要あり。

5) 推奨プラン（現状の前提で）
  - まずは **軽量運用**: `direct-to-R2` を主に使い、`/api/images/complete` でメタを保存。サムネは別バッチ／Worker で後処理し、必要に応じて段階的に即時生成に切り替える。コスト増は最小化できる。
  - 即時生成を優先しユーザ体験を重視する場合: 小型の Node（Cloud Run / VPS）を使い `sharp` で即時生成。追加コストは概ね **$5–$20/月** のレンジを想定。

6) ドキュメント反映済み箇所
  - `docs/IMAGE_DISTRIBUTION_AND_CDN.md` に「upload handler で sharp を使って生成する」運用と `thumbnails` カラム保存、CDN 配信の手順を記載済みです。

まとめ: 現状の想定（PV・画像数）では、`sharp` を導入しても毎月の直接コストは小さく、UX 向上の効果は大きいです。ただし Cloudflare Pages を使う場合は `sharp` の動作環境が制約されるため、即時生成を選ぶなら別ホスティングを用意する必要があります。まずは `direct-to-R2 + images/complete + バッチ/Worker でサムネ生成` のハイブリッドがリスクとコストのバランスが良い選択です。
# 画像変換方式のコスト試算 (2025-12-02)

公開ページは SSG、データは CSR Fetch（商品/コレクション/プロフィール/レシピ）の前提で、画像サムネイル変換の月額コストを比較します。

## 前提（共通）
- 月間 PV: 6,000〜8,000
- 初期表示でサムネイル 24 枚/訪問（遅延読込含む） → 配信枚数 ≒ 144k〜192k 画像/月
- 商品画像: 600 枚（R2 に原本保管）
- 変換バリアント: 幅 400px（一覧用）を基本。将来的に 800px（詳細ヘッダ）を追加する可能性あり。
- キャッシュ: 変換済サムネイルは R2/CDN にキャッシュし、初回のみ変換を実行。

## 方式 A: Cloudflare Images（リモート画像の変換のみ利用）
- 参照: Cloudflare Images Pricing（Aug 7, 2025）
  - Free: 5,000 unique transformations/月 まで無料（超過は新規変換 9422 エラー）
  - Paid: Unique Transformations: 最初の5,000含む + 以降 $0.50/1,000 unique/月
  - Images Stored / Delivered は「Cloudflare Images に保存した場合のみ」課金。R2 保管のままなら未適用。

- 想定ユニーク変換数
  - 400px 1バリアント: 600（画像枚数と同数）
  - 400px + 800px 2バリアント: 1,200
  → いずれも Free の 5,000 未満。

- 月額概算
  - Freeプランのまま: $0.00（ユニーク5,000未満、配信は R2/CDN 側で実施）
  - もし将来ユニークが 10,000 に増加した場合（例: 多数のサイズバリアント追加）
    - Paid: (10,000 - 5,000) / 1,000 × $0.50 = $2.50/月

- 特記事項
  - 「配信枚数（Delivered）」は Images に保存していない限り課金対象外。
  - Free 超過時は新規変換が 9422 エラーになるため、閾値近傍では Paid への切替を推奨。

## 方式 B: Cloudflare Images（Images に保存＋Variants 配信）
- 課金要素（Paid）
  - Images Stored: $5/100,000 images stored/月
  - Images Delivered: $1/100,000 delivered/月
- 想定
  - 保存: 600枚 → $5 × (600/100,000) ≈ $0.03/月
  - 配信: 144k〜192k delivered → $1 × (1.44〜1.92) ≈ $1.44〜$1.92/月
- 月額概算
  - 合計 ≈ $1.47〜$1.95/月（変換費用は Delivered 側に内包されるため、Transformations 課金は原則発生しない）
- 特記事項
  - 画像の保管先を R2 → Images に切替える必要あり（または二重管理）。
  - 料金は小さいが、運用切替の手間が増える。

## 方式 C: Workers + WASM Sharp（R2 にサムネイル保存）
- 課金前提
  - 変換処理は Workers Free（CPU 10ms/req 上限）では現実的に厳しいため、Workers Paid（Standard）想定。
  - Workers Paid: $5/月（含まれる 3,000万 CPU ms と 1,000万 req は今回規模では十分）
  - R2: 生成サムネイル保管・配信はほぼ Free 範囲内（Storage/Op は微小）。
- 想定ユニーク変換数と CPU
  - 初回変換: 600〜1,200 回/月（100ms/回 仮定）→ 60,000〜120,000 CPU ms/月（含有 30,000,000 ms 内）
- 月額概算
  - Workers 基本料: $5.00
  - R2 超過: $0.00（概ね Free 内）
  - 合計: $5.00/月
- 特記事項
  - オンデマンドで高度な加工（合成・透過・ウォーターマーク等）が可能。
  - 実装/保守コストは最も高い（WASMパッケージ、エラー/タイムアウト制御、最適化）。

## 比較表（USD）
| 方式 | 保管 | 変換課金 | 配信課金 | 月額目安 | 運用/実装コスト |
|---|---|---|---|---:|---|
| A Images Transform（R2原本） | R2 | Free ≤5k unique（超: $0.50/1k） | なし（R2配信） | $0.00（現状） | 低（URL生成のみ） |
| B Images（保存＋配信） | Images | Delivered 課金に内包 | $1/100k delivered | $1.47〜$1.95 | 中（保管切替・Variants管理） |
| C Workers+WASM+R2 | R2 | Workers Paid $5/月 | なし（R2配信） | $5.00 | 高（実装・保守） |

## 結論 / 推奨
- 現状規模（600枚・バリアント1〜2種）なら、
  - 最小コスト: 方式 A（Cloudflare Images Transform を Free で利用）→ $0/月
  - 運用簡素＋課金のわかりやすさを重視するなら: 方式 B（Images に保存）→ ~$2/月
  - 高度な独自加工や将来の特殊処理要件が明確: 方式 C（Workers WASM）→ $5/月

- 即決おすすめ: 方式 A（Free 運用）で開始し、以下を監視:
  - 「ユニーク変換数」> 5,000/月 になりそう → Paid へ（$0.50/1,000）
  - 運用をさらに単純化したい → 方式 B へ移行（~$2/月）
  - 高機能加工の要求が出た → 方式 C を PoC のうえ採用

## メモ
- 数値は Cloudflare 公開ドキュメント（Images Pricing, 2025-08-07）に基づく。R2/Workers は既存の試算と同一前提。
- 将来 PV/画像数/バリアント数が増加した場合は、閾値（5,000 unique/月、Delivered スループット）を再評価。
