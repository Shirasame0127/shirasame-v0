# コレクションと商品管理 — 仕様とカラム一覧

目的: 本ドキュメントはChatGPTに本リポジトリで使われる「コレクション機能」と「商品管理機能」を完全に理解させるための参照資料です。表記は実際のDBカラム名（英語）と簡潔な日本語説明を併記します。

---

## 概要
- エンティティ: `products`, `product_images`（または `images`/`product_images`）、`collections`, `collection_items`。
- 主なAPI: `GET /api/products`（shallow/full, limit/offset）, `GET /api/collections`（public visibility のコレクションを product と結合して返す）。
- 権限: `products` は RLS（Row Level Security）で公開済み商品は誰でも参照可能（`published=true`）、編集系は owner のみ。
- 表示モデル: フロントは shallow メタ（サムネ等）を受け取り、必要に応じてフルの product を取得する。

---

## `products` テーブル（主なカラム）
- `id` uuid — 主キー
- `user_id` uuid — 作成者（owner）参照 `users(id)`
- `title` text — 商品名
- `slug` text — 一意のスラッグ（URL 用）
- `short_description` text — 短い説明
- `body` text — 詳細本文
- `tags` text[] — タグ配列
- `price` integer — 価格（整数）
- `published` boolean — 公開フラグ（`true` が公開）
- `created_at` timestamptz — 作成日時
- `updated_at` timestamptz — 更新日時
- `affiliate_links` jsonb — （追加マイグレーションあり）アフィリエイトリンク配列 `{ url, label, site }` のような構造
- 備考: 型定義は `shared/types/index.ts` の `Product` に合わせ、`images: ImageMeta[]` を持つことが期待される。

---

## `product_images` / `images` テーブル（商品画像）
（プロジェクトにより `images` または `product_images` 名が使われる。主なカラム）
- `id` uuid — 主キー
- `product_id` uuid — 外部キー `products(id)`
- `key` text — R2 等に保存したオブジェクトのキー（key-only 方針）。
- `url` text — 旧来のフルURL（読み取りのみ、移行中に NULL 化する）
- `width` integer — 画像幅（任意）
- `height` integer — 画像高さ（任意）
- `aspect` numeric/text — アスペクト等（任意）
- `role` text — 役割（`main`, `thumbnail` など）
- 備考: 画像は key-only 方針（DBには `key` のみを保存し、フルURLは非推奨）。

---

## `collections` テーブル（コレクション）
- `id` uuid — 主キー
- `user_id` uuid — 作成者参照 `users(id)`
- `title` text — コレクション名
- `slug` text — 一意のスラッグ
- `description` text — 説明（任意）
- `visibility` text — 表示状態（例: `public` / `draft`）
- `order` integer — コレクションの手動ソート順（2025-12-15 付で追加された列）
- `created_at` timestamptz — 作成日時
- 備考: API は `collections` → `collection_items` → `products` の順で合成して返す（products は shallow メタで返却されることが多い）。

---

## `collection_items` テーブル（コレクション内のアイテム）
- `id` uuid — 主キー
- `collection_id` uuid — 外部キー `collections(id)`
- `product_id` uuid — 外部キー `products(id)`
- `position` / `order` / `created_at` — 順序管理用カラム。実装差分あり（`order` カラムを導入し、既存行は `created_at` に基づいてインデックス順序にバックフィルされるマイグレーションあり）
- `added_at` / `created_at` timestamptz — 追加日時
- 制約: `unique(collection_id, product_id)`（重複防止）
- インデックス: `(collection_id, "order")` 等のインデックスが存在。

---

## 関連テーブル / 補助モデル
- `affiliate_links` テーブル: `product_id` を参照しクリックログ等を保持する（`affiliate_clicks` / `affiliate_links`）。
- `recipes` / `annotations` などは商品ピン連携があり、`annotations.linked_product_id` が `products.id` を参照する。

---

## API 振る舞い（運用ルール）
- `GET /api/products`:
  - `shallow=true` や `limit`/`offset` に対応。公開商品は `published=true` でフィルタされる。
  - public shallow list はサーバ側キャッシュ（10s）を持つ。
- `GET /api/collections`:
  - `collections` を取得後 `collection_items` から `product_id` を集約、該当 `products` と画像/affiliate_links を取得して合成する。
  - 各コレクションの `products` 配列は順序を保持する（`collection_items.order` に基づく）。
- `GET /api/products?id=<id>`: 単一商品のフルデータ取得（編集画面用）。

---

## 権限とセキュリティ
- `products` テーブルは RLS を有効化。公開済み商品は全員が参照可能（`published = true` ポリシー）。
- 管理操作（編集/削除/挿入）は `auth.uid() = user_id` のチェックで制限。
- `internal-api-worker` 等は owner チェックを強制して上流 DB をクエリする実装がある（`user_id=eq.<userId>` を付与）。

---

## 実装注記（重要）
- 画像は key-only 方針（DB に `key` を保存）。フロントは `key` を受けて配信ドメイン（例: `https://images.shirasame.com/cdn-cgi/image/.../<key>`）を組み立てる。
- `collections` / `collection_items` の順序はマイグレーションで `order` を付与している。フロントはこの順序を尊重して表示する。
- `products` の `affiliate_links` は JSONB 等で保存され、公開 API に含められる。
- API 層では N+1 問題の可能性があるため、`collection_items` → `products` → `product_images` の取り方は最適化の余地がある旨をドキュメントに記載している。

---

## 参照ファイル（実装ソース）
- `shared/types/index.ts` — `Product` / `Collection` 型定義
- `docs/DATABASE_MIGRATION.md` — テーブル作成スニペット（products, collections, collection_items など）
- `public-worker/docs/API_REFERENCE.md` / `docs/API_CURRENT_ROUTES.md` — `/products` `/collections` の挙動
- マイグレーション: `migrations/2025-12-15-*`, `migrations/2025-12-24-add-affiliate-links-to-products.sql`

---

このファイルは「ChatGPTが理解するためだけ」の参照資料として作成しました。必要なら追加のカラムや最新マイグレーションを拾って追記します。