# 管理ページ 仕様書（実装に合わせた最新版）

この仕様書は、現在の `admin-site` 実装および `cloudflare/admin-api-proxy`（Worker）で実際に動作している挙動に合わせて更新したものです。実装者・運用者が参照できるよう、機能一覧、主要 API、認証・Cookie の取り扱い、画像のアップロード／配信フロー、デプロイ要件、運用チェック手順をまとめています。

**対象ファイル（参照）**: `admin-site/*`, `cloudflare/admin-api-proxy/*`, `shared/*`

---

## 変更点（要約）
- クライアントの管理 API 呼び出しは `apiFetch()` に統一されています（`admin-site/lib/api-client.ts`）。`apiFetch()` はデフォルトで `{ credentials: 'include', redirect: 'manual' }` を付与し、サーバ側 whoami の検証に基づく認可を前提とします。
- Cloudflare Worker（`cloudflare/admin-api-proxy`）は `/api/auth/*` を自前処理（`set_tokens`, `whoami`, OAuth callback/fragment 捕捉）し、それ以外の `/api/*` を `PUBLIC_WORKER_ORIGIN` へフォワードします。公開先に API が存在しない場合は Supabase REST を使った読み取りフォールバックがあります。
- 画像は DB に「キーのみ」を保存する方針（key-only）。フロントは `getPublicImageUrl()` を使って公開 URL を構築し、公開ページと同じ配信ロジック（`NEXT_PUBLIC_IMAGES_DOMAIN` / `IMAGES_DOMAIN` または `https://images.shirasame.com`）を用います。

---

## 機能一覧（実装ベース）
- 認証: Google OAuth（コード交換 + フラグメントフォールバック）と Supabase 認証
- サーバ権威の whoami（`GET /api/auth/whoami`）により管理 UI の初期表示・ガードを行う
- 画像アップロード: 署名付き直接アップロード（Cloudflare Images/R2）＋プロキシ経由のフォールバック
- 画像メタは DB にキーのみ保存（公開 URL は保存しない）
- 管理 CRUD API（タグ・コレクション・製品・レシピ等）は public-worker 側で実装され、Worker がフォワードする

---

## 主要 API（現在の実装に合わせた一覧）

- 認証系
  - `GET /api/auth/whoami`
    - 機能: HttpOnly Cookie（`sb-access-token`）を用いて現在のユーザーを返す。`credentials: 'include'` で呼び出すこと。
    - レスポンス: 200 + JSON（ユーザ情報） / 401（未認証）
  - `POST /api/auth/set_tokens`
    - 機能: ブラウザが受け取ったトークン（フラグメントやサーバ側交換結果）を受け取り、HttpOnly Cookie を発行する（`sb-access-token`, `sb-refresh-token`）。
    - 備考: Set-Cookie は `Domain=admin.shirasame.com; HttpOnly; Secure` を付与する想定
  - `GET /api/auth/google` / `GET /api/auth/callback`
    - 機能: Google OAuth のリダイレクト／コード交換を処理。フラグメントで返る場合は fragment-capture HTML を返し、クライアントが `/api/auth/set_tokens` にポストする流れがある。

- 画像系
  - `POST /api/images/direct-upload`
    - 機能: 署名付き PUT URL（Cloudflare Images / R2）を返す。レスポンスは `{ result: { uploadURL, id, publicUrl?, key? } }` のような構造。
  - `POST /api/images/upload`
    - 機能: プロキシ経由でサーバ側にファイルを送り、サーバが保存して key を返す（multipart/form-data）。
  - `POST /api/images/complete`
    - 機能: 署名アップロード完了通知として、サーバにメタデータを渡して DB に登録する。

- 管理 CRUD（例）
  - `GET/PUT /api/admin/settings`、`GET/POST/PATCH/DELETE /api/admin/tags`、`/api/admin/products` など。いずれも `apiFetch()`（`credentials: 'include'`）を使って呼び出すこと。

---

## 認証・Cookie（実装の挙動）

- Cookie 名称: `sb-access-token`, `sb-refresh-token`（Supabase 互換）
- 既定の Cookie 属性（Worker の実装では少なくとも次を付与）:
  - `HttpOnly; Secure; Path=/; Domain=admin.shirasame.com; SameSite=Lax`
  - OAuth の挙動やクロスサイト POST が必要な場合、`SameSite=None` を検討する（その場合 `Secure` は必須）。
- クライアント実装: 管理 UI は `admin-site/lib/api-client.ts` の `apiFetch()` を通して API を呼び、401 が返れば `/admin/login` にリダイレクトするよう設計されています。

---

## 画像アップロードと配信（実装に合わせた詳細）

- DB 保存: すべて `key`（例: `images/2025/12/07/abcd1234.jpg`）のみを保存する。フル URL を DB に保存しない（key-only 方針）。
- フロントは `getPublicImageUrl(key)` を使い、`NEXT_PUBLIC_IMAGES_DOMAIN` / `IMAGES_DOMAIN` 環境変数、あるいは `https://images.shirasame.com` を用いて公開 URL を生成します。
- アップロード手順（実装の典型）:
  1. `POST /api/images/direct-upload` を呼んで署名付き URL を取得
  2. 取得した URL へ `PUT` でファイルをアップロード（CORS に注意）
  3. `POST /api/images/complete` を呼んでメタを確定／DB に保存
  4. 環境やブラウザ制限で直接 PUT が使えない場合は `POST /api/images/upload` を使ってプロキシ経由で保存する
- 配信: 表示時は `buildResizedImageUrl()` や `responsiveImageForUsage()` を使い `cdn-cgi/image/...` 経路で変換配信を行う設計（Cloudflare Image Resizing を前提）。

---

## 配信・デプロイ（運用メモ）

- ホスティング: `admin-site` は静的ビルド（Next.js）を Pages / Vercel などにデプロイし、ドメイン `admin.shirasame.com` で配信することを想定。
- Worker ルート: Cloudflare 上で `admin.shirasame.com/api/*` を `admin-api-proxy` Worker に割り当てる（重要: `/*` など全トラフィックを Worker 経路にしないことで静的資産が直接配信される）。
- Worker シークレット: `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `PUBLIC_WORKER_ORIGIN`, `GOOGLE_CLIENT_ID/SECRET` などを Workers の環境に設定する。

---

## 検証手順（実行コマンド）

- ローカルでのビルド／型チェック（admin-site）:
```powershell
cd .\admin-site
pnpm install
pnpm build
```

- whoami の簡易確認（ブラウザの Console または PowerShell）:
```powershell
curl.exe -v "https://admin.shirasame.com/api/auth/whoami" --cookie "sb-access-token=<TOKEN>; sb-refresh-token=<REF>"
```

- Worker の debug（存在する場合）:
```powershell
curl.exe -v "https://admin.shirasame.com/api/auth/debug"
```

- 画像 HEAD チェック（例）:
```powershell
curl.exe -I "https://images.shirasame.com/cdn-cgi/image/width=400,format=auto/<YOUR_KEY>"
```

---

## 実装上の注意（チェックリスト）

- `apiFetch()` を管理 UI 内の API 呼び出しに必ず使う（`credentials: 'include'` を付与するため）。
- Cloudflare Worker の Route を `admin.shirasame.com/api/*` に正しく設定する（静的資産を巻き込まない）。
- `Set-Cookie` ヘッダの `Domain` を `admin.shirasame.com` にすること。
- 画像は DB に key のみ保存し、フロントは `getPublicImageUrl()` で公開 URL を解決する。

---

## 運用ノート（最近の作業）

- リポジトリ内の管理 UI 呼び出しを `apiFetch()` に統一する変更を適用済み（ブランチ: `feature/unify-admin-apiFetch-image-fix-20251208`、PR: https://github.com/Shirasame0127/shirasame-v0/pull/6）。
- `admin-site` の `pnpm build` はローカルで成功しています（2025-12-08 ローカル検証済み）。

---

もしこの仕様書のさらに細かい箇所（Cookie の `SameSite` 設定、Worker の具体的なフォワードルール、あるいは `getPublicImageUrl()` のドメイン決定ロジック）を実際の本番挙動に合わせて微調整したければ、どの点を優先するか指示してください。次は以下を実行できます:

- A: Worker の `Set-Cookie` ヘッダ属性を実際の本番リダイレクトフローに合わせて調整するパッチを作成
- B: 代表画像キーを受け取って私が HEAD を自動で叩き、配信状況（200/403/404 と `cf-cache-status`）を報告
- C: PR にビルド結果・変更点の詳細な説明を追加してレビュー向けに整備

