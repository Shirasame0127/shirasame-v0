---
title: 共通仕様定義書
language: ja
---

# 共通仕様定義書

対象: `admin-site` と公開 API（public-worker）で共通に使う「画像キー(key-only) -> 公開URL -> レスポンス画像(複数サイズ)」の取扱い仕様。

目的:
- 画像は「キーのみ」を DB に保存する（key-only ポリシー）。
- フロントエンドはキーから公開 URL を生成して表示する。画像の変換やレスポンシブ配信は共通ユーティリティで行う。
- エッジ（ワーカー/CDN）に既に変換済みのキャッシュがあればそれを使い、無ければ必要なサイズで変換して配信するフローを定義する。

この仕様は初心者にもわかるように、背景・API・フロント側の実装例・トラブルシュート手順を含みます。

---

## 背景（用語）
- 画像キー(key): 画像を一意に示す文字列。例: `images/2025/12/16/abcd1234.webp`
- key-only ポリシー: DB には `key`（や `recipe_image_keys` の配列）だけを保存し、フロント/表示側で URL を生成する。
- 公開URL: `getPublicImageUrl(key)` で生成する URL。ケースにより `https://<IMAGES_DOMAIN>/<key>` や `/images/<key>` の相対 URL になる。
- 変換(レスポンシブ): `responsiveImageForUsage` や `buildResizedImageUrl` のようなユーティリティで、用途に応じた `src` / `srcset` を作る。
- エッジキャッシュ: Worker / CDN が `Cache-Control` 付きで変換済み画像を保存している場合、それを優先して配信する。

参照実装: `shared/lib/image-usecases.ts` に共通ユーティリティが実装されています（`getPublicImageUrl`, `buildResizedImageUrl`, `responsiveImageForUsage` 等）。

---

## 高レベルフロー（図で理解）

1) 管理画面でユーザが画像をアップロード
   - フロントは `/api/images/direct-upload` 等で一時アップロード、最終的に `/api/images/complete` を呼び `key` を受け取る。
2) サーバ（public-worker）の `/api/images/complete` は DB に `key` を key-only で保存し、{ key } を返す
3) 管理画面は受け取った `key` をレコード（例: `recipes.recipe_image_keys` や `users.profile_image_key`）に PUT/UPDATE で保存する
4) 表示時、フロントは `getPublicImageUrl(key)` または `responsiveImageForUsage(key, options)` で `src`/`srcset` を得て `img` に設定
5) ブラウザが該当 URL にアクセスすると、public-worker が `Cache-Control` の有無を確認して:
   - 既にエッジに変換済みがあればそれを返す（高速）
   - 無ければ Worker が R2 から原データを取得し、必要なら変換 (Cloudflare Image Resizing 等) して返し、エッジにキャッシュする

---

## API 仕様（要点）

- POST /api/images/complete
  - 説明: 管理画面がアップロード完了時に呼ぶ。アップロード処理の最終確定を行い DB に key を保存する。
  - 受け取り例 (multipart/form-data): file, key(任意), targetId, assign 等。
  - 返却例: `{ key: "images/2025/12/16/abcd1234.webp", contentType: "image/webp" }`

- PUT /api/admin/recipes/:id
  - 説明: `recipe_image_keys` の更新など管理用のフル更新 API。管理 UI はアップロード後にこの API で `recipe_image_keys` を append する。
  - ボディ例: `{ recipe_image_keys: [ "images/..." ] }`

- GET /images/*
  - 説明: 画像配信エンドポイント。`/images/<key>` 形式の URL を受け取り、R2 からオブジェクトを読み出すか、既に変換済みのエッジキャッシュを返す。
  - ヘッダー: `Cache-Control` や ETag/Last-Modified が付与され、CDN/エッジで再利用される。

セキュリティ: 管理系 API は admin-origin またはトークン認証が必須（`resolveRequestUserContext` による検証）。未認証での `/api/admin/*` 呼び出しは 401 を返す。

---

## フロントエンド実装ガイド（管理 UI 側）

基本ルール:
- DB に保存するのは常にキーだけ（例: `recipe_image_keys: string[]`）。
- 表示は `getPublicImageUrl` で得た URL を `img` の `src` に入れる。
- レスポンシブ表示には `responsiveImageForUsage` を使い `src` と `srcSet` を生成する。

例: アップロード完了時の処理（擬似コード）

```ts
// 1) 画像をアップロード -> /api/images/complete を呼ぶ
const resp = await fetch('/api/images/complete', { method: 'POST', body: formData })
const json = await resp.json()
const key = json.key // 例: "images/2025/12/16/abcd1234.webp"

// 2) 管理レコードにキーを追加
await fetch(`/api/admin/recipes/${recipeId}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ recipe_image_keys: [...existingKeys, key] })
})

// 3) 表示用にプレビューを更新
const previewUrl = getPublicImageUrl(key)
previewImg.src = previewUrl
```

例: 編集画面での表示（`img` に `src` と `srcSet` を設定）

```tsx
import { responsiveImageForUsage } from '../../shared/lib/image-usecases'

const { src, srcSet } = responsiveImageForUsage(key, { usage: 'editor', widths: [360, 720, 1080] })
return <img src={src} srcSet={srcSet} alt="プレビュー" />
```

※ `responsiveImageForUsage` の具体的な引数はプロジェクトの実装に合わせてください（例: aspect, widths, fit など）。

---

## フロントエンド実装ガイド（プロフィール画像の例）

ユースケース: `設定画面` でプロフィール画像をアップロードし、ページに即時反映させ、DB には key を保存する流れ。

1) ユーザがファイルを選択 → `POST /api/images/complete` を呼ぶ
   - レスポンス `{ key }` を受け取る
2) `PUT /api/admin/users/:id` で `profile_image_key` を保存（server-side）
3) 表示（ページやヘッダ）では `getPublicImageUrl(profile_image_key)` を呼んで `img` に設定

実際のリクエスト/レスポンスの流れ（具体例）:

- リクエスト (ブラウザ -> Worker)
  - POST /api/images/complete (multipart/form-data)
- レスポンス (Worker -> ブラウザ)
  - 200 OK
  - Body: `{ "key": "images/2025/12/16/abcd1234.webp", "contentType": "image/webp" }`
- 続けて (ブラウザ -> Worker)
  - PUT /api/admin/users/<userId>
  - Body: `{ "profile_image_key": "images/2025/12/16/abcd1234.webp" }`

表示側では以下のように変換とキャッシュを意識して表示します:

```html
<img src="/images/images/2025/12/16/abcd1234.webp" alt="プロフィール" />
```

注意: `getPublicImageUrl` は環境変数 `IMAGES_DOMAIN` や `R2_PUBLIC_URL` に依存して絶対 URL を生成する場合があります。開発環境では相対パス `/images/<key>` を使うことが簡便です。

---

## エッジ・キャッシュの挙動と考慮点

- public-worker の `/images/*` ハンドラは、次のいずれかを返します:
  1. 既にエッジ（CDN）に変換済みのオブジェクト（Cache-Control, ETag 付き）
  2. R2 から元ファイルを取得して一時変換（必要なら Cloudflare Image Resizing 等）し、適切な Cache-Control を付けて返す

- 変換済みオブジェクトがあればレスポンスは高速で、ブラウザは Cache-Control に従って次回リクエストを抑制します。
- サイズ別のバリエーション（例: 320/640/1280）は `srcset` を使いブラウザが自動選択します。変換済みの各サイズはエッジにキャッシュされます。

キャッシュウォームアップのヒント:
- ページ表示直後に小さな画像サイズ（例: 320px）へのリクエストを先に飛ばすと、表示に必要な変換が先にキャッシュされやすくなります。
- 管理者 UI のアップロードハンドラ側で、代表的な表示サイズへ事前レスポンスを叩いておく「ウォームアップ」実装も可能（ただしコストがかかる）

---

## 実装時のチェックリスト（開発者向け簡易）

- [ ] 画像は `POST /api/images/complete` で upsert し、key を受け取る
- [ ] 管理 UI は key のみを DB に保存する（例: `recipe_image_keys`、`profile_image_key`）
- [ ] 表示コンポーネントは `getPublicImageUrl` / `responsiveImageForUsage` を使って `src`/`srcSet` を生成
- [ ] public-worker の `/images/*` が 既存キャッシュを優先して返すことを確認
- [ ] admin API (`/api/admin/*`) 呼び出しは認証（cookie またはヘッダ）で保護されていることを確認

---

## よくあるトラブルと対処法

- 画像が表示されない（404）
  - 保存した値が URL 文字列そのものだった場合、`ensureImageKey` のようなヘルパでキーだけを抽出して DB に保存する必要があります。
  - ブラウザの Network で `/images/<key>` のレスポンスを確認。Worker が 404 を返しているなら、R2 にオブジェクトが存在するか、`key` のパスが正しいかを確認。

- 編集画面でダミー (例: "テストデータ") が表示される
  - 編集ページが admin エンドポイントでドラフトを取得できていない（認証失敗や wrong endpoint）可能性あり。DevTools の Network で `/api/admin/recipes/:id` を確認。

- 変換済みサイズが使われず毎回変換される（遅い）
  - キャッシュヘッダー（Cache-Control）や Worker のキャッシュ挙動を見直す。レスポンスに `Cache-Control: public, max-age=...` が付いているか。

---

## 具体例：一連の REST/フロントフロー（プロフィール画像）

1) フロントでファイルを選択 → `POST /api/images/complete` (FormData)
   - 返却: `{ key: 'images/2025/12/16/abcd1234.webp' }`
2) フロントは `PUT /api/admin/users/<id>` ボディ `{ profile_image_key: 'images/2025/12/16/abcd1234.webp' }`
3) 表示側は `const url = getPublicImageUrl(profile_image_key)` → `<img src={url} />`
4) ブラウザが初回に `/images/.../abcd1234.webp` を取得 → Worker が R2 から返しキャッシュ
5) 別サイズへのアクセス（`srcset`）があれば Worker は必要に応じて変換し、それぞれをエッジにキャッシュ

---

## 参考 / 実装ファイルの位置
- 共通ユーティリティ: `shared/lib/image-usecases.ts`
- 管理 UI: `admin-site/components/image-upload.tsx`, `admin-site/app/admin/recipes/edit/page.tsx`, `admin-site/components/recipe-display.tsx`, `admin-site/components/pin-overlay.tsx`
- ワーカー: `public-worker/src/index.ts`（`/api/images/complete`, `/images/*`, `/api/admin/recipes/:id` など）

---

## 最後に（初心者向けワンポイント）
- DB に URL を保存しない理由: 環境（ドメイン/CDN）の変更に柔軟に対応できるため。キーだけ保存しておけば、将来 URL の構成を変えても DB 側のデータ移行が不要になります。
- まずは「upload -> /api/images/complete -> key を得る -> record に保存 -> getPublicImageUrl(key) で表示」の流れを動かすことを目指してください。動作したら `responsiveImageForUsage` を使った `srcset` 化、エッジのキャッシュ確認へ進むと段階的に仕上がります。

もし、この仕様書を基にチュートリアル用の小さなデモ（最小構成）を作成してほしければ、次にその実装スケルトンを作ります。どちらを先に進めますか？

---

ファイル作成日: 2025-12-16
