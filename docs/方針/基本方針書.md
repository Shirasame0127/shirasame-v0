# プロジェクト基本方針書 (Architecture Overview)

最終更新: 2025-12-04

## サマリ
- この文書は `docs/` 内にある全ドキュメントをもとに、プロジェクト全体のアーキテクチャ、デプロイフロー、API 設計方針、セキュリティ要件、コーディング規約を一つにまとめたものです。
- 主要コンポーネント: Cloudflare Pages（静的配信: public-site / admin-site）、Cloudflare Workers（公開 API）、Supabase（DB/Auth）、Cloudflare R2（画像原本ストレージ）

---

## 1. 全体アーキテクチャ

- Public site: `public-site` (Next.js App Router)
  - 挙動: クライアント中心のフェッチ（CSR）で動作。ビルドは Next.js（`next build`）。環境変数 `NEXT_PUBLIC_API_BASE_URL` を用いて Workers の公開 API を参照。
  - 画像: R2 の原本 URL を正規化し、必要に応じて `cdn-cgi/image` プロキシ（Worker 経由）でサムネイルを配信。

- Admin site: `admin-site` (Next.js) — Public site と同等のビルド設定/環境を使用。管理 UI は静的配信（Pages）で JS により Workers の管理 API を呼ぶ想定。

- API: Cloudflare Workers (`public-worker`) が公開 API を提供。主なエンドポイントは `/products`, `/collections`, `/recipes`, `/tags`, `/tag-groups`, `/site-settings`, `/amazon-sale-schedules`, `/profile`。
  - 管理操作は `/admin/*` プレフィックスで受け付け、`INTERNAL_API_BASE` に設定された内部 API（管理コントロール面）へプロキシできる。プロキシは `X-Internal-Key` による簡易認証をサポート。

- データ: Supabase (Postgres)
  - RLS（行レベルセキュリティ）を用いて公開 API 用の anon クライアントでも安全に公開データを返す設計。
  - 画像メタ等は `product_images`/`recipes.images` で管理。移行や正規化に関する手順は `docs/ARCHITECTURE.md` を参照。


## 2. ビルド方式 / SSR / SSG / CSR

- public-site は App Router 構成だが、主要ページは `"use client"` を多用しており、**CSR（クライアントサイド取得）を主軸**とする運用。
- next.config.mjs には `NEXT_OUTPUT_EXPORT=1` による `output: 'export'` のサポートを残しており、Cloudflare Pages での静的エクスポート配信にも対応可能。
- admin-site は public-site とビルド設定を揃え、Pages での静的配信 + クライアント側 JS による API 呼び出しで動作するようにする。


## 3. API 設計方針

- 公開 API（Workers）:
  - GET 系はキャッシュ（Cache API）と ETag を用い、CDN キャッシュとブラウザの条件付きリクエストで通信量を削減。
  - Zod を用いたクエリ検証により基本的な入力制約を実装。
  - 返却 JSON 形式は `{ data: ..., meta?: ... }` を基本とする。

- 管理 API:
  - Workers は `/admin/*` を `INTERNAL_API_BASE` にプロキシする仕組みを提供。内部 API 側で認証・ロールチェックを厳格に実施すること。
  - 管理 API を Worker 側で直接実装する場合は、Service Role key 等の扱いに十分注意し、Workers の環境変数に平文キーを置かない運用も検討する。

- 画像関連:
  - 画像は R2 に原本を保持。公開時は `NEXT_PUBLIC_R2_PUBLIC_URL` を基に正規化。リスト用は Worker の `/images/thumbnail` プロキシを通すか、R2 上の事前生成バリアントを参照。
  - 画像エンドポイントは変換ドメイン (Cloudflare Images / cdn-cgi/image) を利用し、固定幅（200/400/800等）のユニーク変換にて配信。


## 4. デプロイ / 配信フロー

1. Public site:
   - `pnpm build`（Next 16）→ Cloudflare Pages にデプロイ（または `next export` で静的出力）。
   - 環境変数: `NEXT_PUBLIC_API_BASE_URL`, `NEXT_PUBLIC_R2_PUBLIC_URL`, `NEXT_PUBLIC_CDN_BASE` 等を Pages の UI に設定。

2. Admin site:
   - public-site と同様のビルド設定で Pages にデプロイ。
   - 管理側で `NEXT_PUBLIC_API_BASE_URL` は公開 API を指し、管理操作で `INTERNAL_API_BASE` が必要な場合は Worker 経由でプロキシ（`X-Internal-Key` を付与）する。

3. Workers:
   - `wrangler.toml` で環境ごとの `PUBLIC_ALLOWED_ORIGINS`, `INTERNAL_API_BASE`, `INTERNAL_API_KEY` を設定。
   - キャッシュの TTL と stale-while-revalidate ポリシーを適切に設定して無料枠のリソース使用を抑制。


## 5. セキュリティ要件

- 公開 API:
  - Supabase の RLS を有効にし、公開用 anon キーでアクセスできる範囲を限定。
  - CORS は `PUBLIC_ALLOWED_ORIGINS` で制御。Pages のドメインのみを許可することを推奨。

- 管理 API:
  - Worker の `/admin/*` プロキシは **内部キーによる認可** を行う（`X-Internal-Key` と `INTERNAL_API_KEY` を照合）。
  - 内部 API 側でも必ずセッション認証・権限チェックを実施すること。API キーは短寿命化、ローテーションを考慮する。
  - `SUPABASE_SERVICE_ROLE_KEY` 等の強権限キーは、Workers の環境変数や CI の Secret に保存し、クライアント側に露出させない。


## 6. コーディング規約（主要）

- TypeScript を使用する。型はできるだけ明示（any を最小化）。
- API レスポンスは常に `{ data, meta? }` を返す。
- 画像 URL は `lib/image-url.ts` の `getPublicImageUrl` 等を使って一元変換。
- フロントエンドのデータ取得は可能な限りキャッシュを意識して実装（冪等な GET を利用、条件付きリクエストを尊重）。
- DB 周りの変更はマイグレーションスクリプトを `sql/` に追加し、既存データのバックアップと検証を必須とする。


## 7. 参考（参照したドキュメント）
- `docs/ARCHITECTURE.md`
- `docs/API.md`
- `docs/API_CURRENT_ROUTES.md`
- `docs/WORKERS_PUBLIC_API.md`
- `docs/WORKER_PRODUCTS_API.md`
- `docs/IMAGE_DISTRIBUTION_AND_CDN.md`
- `docs/SSG移行_CloudflarePages.md`
- `docs/SUPABASE_RLS_TEMPLATES.md`
- `docs/COST_ESTIMATE_2025-12-02.md`
- `docs/VARIANT_GENERATION_COST_ESTIMATE_2025-12-03.md`

---

この文書は随時更新します。主に設計に関わる重大変更（画像方針、RLS 設定、配信ドメインの変更等）があった場合はここを起点に見直してください。
