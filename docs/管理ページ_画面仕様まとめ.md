# 管理ページ — 画面仕様まとめ

目的: 管理画面の各画面（ページ）に関する機能仕様、期待される API 呼び出し、認可/スコープ要件、アップロード・画像フロー、UI 挙動（エラー/401 時の振る舞い）を一箇所にまとめ、デプロイ前のチェックと QA を容易にする。

**対象**
- `admin-site` の管理画面全般（レシピ、プロダクト、コレクション、タグ、サイト設定、ユーザー、Amazon セールス、フォント・画像管理 等）

**共通ルール（全画面）**
- 認証: 管理画面は `whoami`（`/api/auth/whoami`）でサーバー側の認証状態を確定してから UI を表示する。クライアントの localStorage ミラーはセキュリティ用の根拠としない。
- 401 ハンドリング: 全 API 呼び出しは `admin-site/lib/api-client.ts` の `apiFetch` を通す。401 を受けたらトーストに「ログイン情報が見つけられなかったよ」を表示し `auth.logout()` を実行、`/admin/login` にリダイレクトする。
- データスコープ: 管理画面内の全ての DB 取得は「必ず」現在の `user_id` を使ってスコープする。クライアント側キャッシュ（`admin-site/lib/db/storage.ts`）の `getAll(userId?)` / `refresh(userId?)` を利用し、呼び出し元は `getCurrentUser()` から `id` を取得して明示的に渡すこと。
- アップストリーム信頼: INTERNAL_API（public-worker あるいは internal-api-worker）がトークン検証を行い、owner フィルタを強制することを推奨（JWK/JWT 検証 + Supabase `/auth/v1/user` のフォールバック）。DB 側に RLS を追加して DB レベルでも owner を強制する。

**ページ別仕様（重要順）**

**1. /admin (ダッシュボード)**
- 機能: 概要、最近のアイテム、各管理ページへのリンク
- API: `/api/products` `/api/recipes` などを `db.*.getAll(userId)` で取得して表示
- UX: 認証未確認時はローダー。whoami 確認後にキャッシュから表示。

**2. /admin/recipes**
- 機能: レシピ一覧、作成、編集、削除、公開切替
- API: `/api/recipes`、編集/削除は `/api/admin/recipes/:id` を利用
- クライアント: `db.recipes.getAll(userId)` / `db.recipes.refresh(userId)` を使用
- 画像・ピン: レシピごとに `db.recipePins.refresh(recipeId)` を呼び、他ユーザーのピンを取得しないよう注意

**3. /admin/recipes/[id]/edit**
- 機能: レシピ編集、画像トリミング、ピン編集、商品紐付け
- API: `/api/admin/recipes/:id` (PUT), `/api/admin/recipe-pins` 系
- 注意点: 編集時は `db.recipes.refresh(userId)` を使って対象ユーザーのレシピのみを読み込む。`db.products.getAll(uid)` で商品をスコープして使用する。

**4. /admin/products**
- 機能: 商品一覧、作成、編集、削除、公開状態管理
- API: `/api/products`、管理操作は `/api/admin/products` を使用
- クライアント: `db.products.getAll(userId)`／`db.products.refresh(userId)` を利用

**5. /admin/collections**
- 機能: コレクション一覧、商品追加・削除、順序管理
- API: `/api/collections`, `/api/admin/collection-items` など。コレクションの `productIds` 更新は `/api/admin/collections/:id` に PUT
- クライアント: `db.collections.getAll(userId)` を利用。`getById` の戻り値を使用する際は取得オブジェクトの `userId` を確認すること。

**6. /admin/tags, /admin/tag-groups**
- 機能: タグ管理、カテゴリ管理
- API: `/api/tags`, `/api/tag-groups`, 管理用は `/api/admin/tags/*` 等へ転送
- クライアント: `db.tags.*` を使用。タグ保存時は `api/admin/tags` へ POST

**7. /admin/amazon-sales**
- 機能: Amazon セールスのスケジュール作成・管理、関連商品の自動抽出
- API: `/api/amazon-sale-schedules` (+ admin endpoints)
- クライアント: セール判定や検索時は `db.products.getAll(uid)` を利用して必ず `uid` を渡す。collection の `userId` と比較して他ユーザー商品を誤って追加しないようにする。

**8. /admin/site-settings, /admin/settings**
- 機能: サイト全体の設定（表示名、プロフィール画像、ヘッダー画像、ローディングGIF 等）
- API: `/api/site-settings`（公開設定取得）と `/api/admin/settings`（管理者による保存）を使用。`/api/admin/settings` はサーバ（public-worker 経由）での保存を前提。
- 画像アップロード: 2 フロー
  - `direct-upload`: 管理 UI が最初に署名取得を試みるエンドポイント -> `/api/images/direct-upload`（署名取得→直アップロード）
  - `upload`（fallback/proxy）: 署名取得が失敗したときに `FormData(file)` を `/api/images/upload` に POST してサーバ側で Cloudflare Images に転送
- 実装上の注意: これら API は `CLOUDFLARE_ACCOUNT_ID` / `CLOUDFLARE_IMAGES_API_TOKEN` を参照する。ENV 未設定時は 500 を返す。

**9. /admin/users**
- 機能: ユーザー一覧・編集（admin の場合）
- API: `/api/profile`（自分のプロフィール）および `/api/admin/users` 系
- クライアント: 必要に応じ `db.user.*` を使う。操作は必ず権限チェックを通すこと。

**ファイル・画像アップロードの詳細フロー**
- フロー A (推奨): 管理 UI → `POST /api/images/direct-upload` で Cloudflare Images の direct upload 情報（uploadURL 等）を取得 → ブラウザから直接 Cloudflare に PUT/POST → 成功時に返される `result`（key/url）を UI が受け取り `/api/admin/settings` 等に保存。
- フロー B (フォールバック): 署名取得失敗時、`POST /api/images/upload` に FormData(file) を送るとサーバが Cloudflare に proxy upload して結果を返す。今回の修正で両方のルートが用意済み。

**運用・デプロイ前チェック（必須）**
- ENV の確認: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `CLOUDFLARE_ACCOUNT_ID`, `CLOUDFLARE_IMAGES_API_TOKEN`, `INTERNAL_API_BASE`（必要なら）、`INTERNAL_API_KEY` 等がステージング/本番に登録済みであること。
- API ルーティング: `admin-site` の `/api/*` は public-worker へ転送するルートと直接処理するルートが混在する。`/api/admin/*` の多くは `forwardToPublicWorker` により upstream が検証して実行する想定のため、upstream の実装が整っていること。
- セキュリティ: DB に RLS（owner = auth.uid）を設定して、アプリ層の不備があっても DB 側で強制されることを確認する。
- テスト: whoami→未認証→401→トースト→`auth.logout()`→`/admin/login` の E2E テストを用意すること。

**QA チェックリスト（抜粋）**
- [ ] 各画面で `db.*.getAll(userId)`／`refresh(userId)` を明示的に呼んでいる。
- [ ] `getById` を使う箇所は、返却オブジェクトの `userId` を検査して他者のデータを表示していない。
- [ ] `/api/images/direct-upload` が 200 を返す（Cloudflare 認証情報が正しい）。
- [ ] `/api/images/upload` が 200 を返す（proxy が Cloudflare に成功転送）。
- [ ] `/api/admin/settings` の保存・取得が正しく upstream に委譲され、UI に反映される。
- [ ] ビルド（`pnpm build`）が成功する。

---
補足: このドキュメントは「管理画面を安全に運用するための実務的チェックリスト」を兼ねます。必要なら各ページの更に詳細な API 例（リクエスト/レスポンス JSON スキーマ）や Playwright の E2E スクリプト雛形を追加します。希望を教えてください。
