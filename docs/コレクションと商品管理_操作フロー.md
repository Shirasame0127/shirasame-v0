# 管理画面操作フロー — 管理者/編集担当向け

このドキュメントは管理画面を操作する担当者向けに、商品・コレクション管理の具体的な操作手順と扱う情報をまとめたものです。

---

## 1. 商品の作成フロー
- 操作手順:
  1. 「新規商品」ボタンを押す。
  2. `title` を入力する（必須）。
  3. `slug` は自動生成されるが、編集可能。保存前に一意性チェックを実行する。
  4. `short_description` / `body` を入力する。
  5. `price` を入力（整数、負値不可）。
  6. `tags` を追加（補完あり）。
  7. 画像をアップロードまたは既存の `key` を選択して紐付けする（必須にする運用の場合あり）。
  8. 必要なら `affiliate_links` を追加。
  9. `published` を切り替え（下書き/公開）。
  10. プレビューで表示を確認して保存。
- 扱うデータフィールド（UI 表示名/内部カラム）:
  - 商品名 (`title`)、スラッグ (`slug`)、短文説明 (`short_description`)、本文 (`body`)、価格 (`price`)、タグ (`tags[]`)、画像 (`product_images.key` / `images.key`)、アフィリエイト (`affiliate_links`)、公開フラグ (`published`)。
- 検証ポイント:
  - `title` 必須、`slug` のユニーク性、`price` が数値かつ 0 以上、画像の `key` が存在すること（運用による）。

## 商品に登録できる情報（入力項目一覧）
以下は管理画面で商品作成／編集時に扱う全ての主要入力項目とその説明、想定 UI（入力コンポーネント）、検証ルール、補足です。

- `title`（商品名）
  - 種類: 文字列
  - UI: 単一行テキスト入力
  - 必須: はい
  - 検証: 文字数上限（例: 255 文字）を推奨
  - 備考: 表示上の主要ラベルになる

- `slug`（URL スラッグ）
  - 種類: 文字列
  - UI: 単一行テキスト（自動生成ボタンと編集可）
  - 必須: はい
  - 検証: 英数字とハイフンのみ、ユニーク性チェック（保存時にサーバ検証）
  - 備考: 空欄時は `title` から自動生成

- `short_description`（短い説明）
  - 種類: 文字列
  - UI: 単一行／短めテキスト入力
  - 必須: いいえ
  - 検証: 推奨文字数（例: 140 文字以内）

- `body`（詳細本文）
  - 種類: 長文（HTML/Markdown など）
  - UI: リッチテキストエディタまたは Markdown エディタ
  - 必須: いいえ
  - 検証: XSS 対策（サニタイズ）をサーバ/クライアントで実施

- `price`（価格）
  - 種類: 数値（整数）
  - UI: 数値入力フィールド（通貨表示）
  - 必須: いいえ（サイト運用ルールによる）
  - 検証: 0 以上、整数のみ
  - 備考: 表示フラグ `showPrice` がある場合はそちらで表示制御

- `showPrice`（価格表示フラグ）
  - 種類: boolean
  - UI: トグルスイッチ
  - 必須: いいえ

- `tags`（タグ）
  - 種類: 文字列配列
  - UI: タグ入力コンポーネント（補完/候補表示）
  - 必須: いいえ
  - 検証: タグの重複排除、候補からの選択を推奨

- `images`（画像配列 / `product_images`）
  - 種類: 配列（`ImageMeta`）
  - UI: 画像アップローダー + ギャラリービュー（順序変更、メイン指定）
  - 要素:
    - `key` (text): R2 用キー（必須）
    - `role` (text): `main`/`thumbnail` 等
    - `alt` (text): 代替テキスト（アクセシビリティ）
    - `width`, `height` (int): 任意
  - 必須: 運用による（一般的に1枚以上推奨）
  - 検証: `key` が存在すること、重複チェック
  - 備考: アップロードは presign/Worker 経由で行い、返却された `key` を保存する

- `affiliate_links`（アフィリエイトリンク）
  - 種類: 配列（JSONB 例）
  - UI: 行追加型フォーム（`url`, `label`, `site` を入力）
  - 必須: いいえ
  - 検証: `url` のフォーマットチェック（有効な URL）

- `related_links`（外部リンク）
  - 種類: 配列／オブジェクト
  - UI: 行追加型フォーム（`url`, `label`）
  - 必須: いいえ

- `published`（公開フラグ）
  - 種類: boolean
  - UI: トグルスイッチ（下書き/公開）
  - 必須: いいえ
  - 備考: 公開時は RLS とキャッシュに注意

- `user_id`（作成者）
  - 種類: uuid
  - UI: 通常は自動設定（ログインユーザー）
  - 必須: はい（内部的に設定）

- `created_at` / `updated_at`（タイムスタンプ）
  - 種類: timestamptz
  - UI: 表示のみ
  - 備考: DB が自動で設定

- `id`（内部識別子）
  - 種類: uuid
  - UI: 表示のみ（編集不可）

### 入力 UX の推奨
- 画像アップロードはドラッグ&ドロップとプログレス表示をサポートする。
- タグは既存タグの補完候補を表示し、重複・空白を防ぐ。
- Slug は自動生成（`title` 由来）し、編集可にする。保存時のユニークチェックは非同期で行う。
- 価格入力は通貨フォーマットを表示しつつ、内部は整数で保持する。

この節は管理画面で入力可能な全フィールドを網羅的に説明しています。必要であれば CSV/Excel 形式でエクスポートします。

## 2. 画像アップロードと紐付け
- 流れ:
  1. 管理画面から画像を選択。
  2. フロントは Worker 経由で R2 に直接 PUT（presign）または Worker 経由アップロードを行う。
  3. アップロード完了後に Worker が `key` を返す。
  4. 管理 UI は返却された `key` を `product_images.key` に保存して紐付け。
- 運用ルール:
  - DB にフル URL を保存してはいけない（`key` のみ保存）。
  - `role`（main/thumbnail 等）、`alt` テキストを管理画面で編集可能にすること。

## 3. 商品編集とプレビュー
- 編集操作: 既存フィールドを編集、画像差し替え、タグ編集、affiliate 編集、公開フラグ変更。
- プレビュー: 画像は `key` を用いた配信URLで表示。公開前に必ずプレビューして崩れを確認。
- 競合対策: 保存時に `updated_at` をチェックし、他者による同時編集があれば警告を表示する。

## 4. コレクション作成・編集
- 主なフィールド: `title`, `slug`, `description`, `visibility`（public/draft）、`order`（表示順）
- アイテム追加: 商品検索で商品を選び `collection_items` を作成して追加。
- 並び替え: ドラッグ&ドロップで順序を変更 → バックエンドに `order` を一括送信して更新。
- 重複制御: 同一商品を同一コレクションに重複追加できない（DB 制約あり）。

## 5. 公開ワークフロー
- `published` フラグで公開/非公開を切替。
- 公開前チェックリスト（推奨）:
  - メイン画像設定済み
  - `slug` の重複なし
  - 価格に誤りなし
  - 関連コレクションでの表示確認
- 公開操作後はキャッシュや CDN 反映を考慮する（必要ならキャッシュ無効化）。

## 6. アフィリエイトリンクの管理
- 商品ごとに複数の `affiliate_links` を保持可能（`url`, `label`, `site` など）。
- クリックログは別テーブル（`affiliate_clicks`）で記録されるため、管理画面から参照できると便利。

## 7. 権限と監査
- 編集権限は `auth.uid() === products.user_id` が基本ルール。管理者ロールは例外的に全商品の編集を許可することがある。
- 操作ログ（誰がいつ変更したか）を残すことを推奨。

## 8. UI 実装上の注意点（要約）
- 画像は必ず `key` ベースで扱う。管理画面でユーザがフルURLを貼り付けるUIは避ける。
- Slug は自動生成＋手動編集を許可し、保存時に一意性検証を行う。
- タグ入力は補完付きにして既存タグを再利用させる。
- 並び替えはクライアントで即時反映し、サーバへ原子的に更新するAPIを用意する。

---

このファイルは `docs/コレクションと商品管理_カラム一覧.md` の補助資料として作成しました。必要ならこの内容を元に画面ごとの CSV/Excel（フィールド一覧）を出力します。

## コレクションに登録できる情報（入力項目一覧）
以下は管理画面でコレクション作成／編集時に扱う主要入力項目とその説明、想定 UI、検証ルール、補足です。

- `title`（コレクション名）
  - 種類: 文字列
  - UI: 単一行テキスト入力
  - 必須: はい
  - 検証: 文字数上限（例: 255 文字）を推奨

- `slug`（URL スラッグ）
  - 種類: 文字列
  - UI: 単一行テキスト（自動生成ボタンと編集可）
  - 必須: はい
  - 検証: 英数字とハイフンのみ、ユニーク性チェック（保存時にサーバ検証）
  - 備考: 空欄時は `title` から自動生成

- `description`（説明）
  - 種類: 文字列（短め〜中程度）
  - UI: 複数行テキスト入力
  - 必須: いいえ

- `visibility`（表示状態）
  - 種類: 列挙（例: `public`, `draft`）
  - UI: セレクトボックスまたはトグル
  - 必須: はい
  - 備考: `public` にすると公開APIで表示される

- `order` / 並び順
  - 種類: 整数
  - UI: ドラッグ&ドロップで直感的に並べ替え、または数値入力
  - 必須: いいえ（表示順を管理する場合は推奨）
  - 検証: 同一コレクション内での連番性を保つこと（バックエンドで補正可能）

- `products`（コレクションに属する商品リスト）
  - 種類: 配列（`product_id` の参照配列）
  - UI: 商品検索と選択インターフェース（検索ボックス + 結果から選択）、ドラッグ&ドロップで順序変更
  - 必須: いいえ
  - 検証: `product_id` が存在すること、同一商品を重複追加しないこと（DB制約）

- `created_at` / `updated_at`（タイムスタンプ）
  - 種類: timestamptz
  - UI: 表示のみ

- `id`（内部識別子）
  - 種類: uuid
  - UI: 表示のみ（編集不可）

### 管理画面 UX 推奨
- コレクション一覧はフィルタ（visibility、作成者等）と検索を備える。
- コレクション編集画面で商品追加はオートコンプリート検索を用いる。
- 並び替えは即時反映し、保存ボタンでサーバに一括送信する。エラー時はロールバックまたは明示的エラー表示を行う。

この節はコレクション管理に必要なフィールドを網羅的に説明しています。CSV/Excel 形式でのエクスポートが必要なら作成します。
