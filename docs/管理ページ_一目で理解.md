# 管理ページ — 一目で理解するための要点（初心者向け）

このドキュメントは、管理ページ（`admin-site`）をざっと見ただけで「何が動いているか」「どこを見れば確認できるか」が分かるように、重要な箇所と簡単な確認手順をまとめたものです。特に操作手順やブラウザでの確認コマンドを中心にしています。

**前提**
- `SUPABASE_SERVICE_ROLE_KEY` は既に Cloudflare Worker のシークレットに設定済みです。
- 管理ページは静的（Pages 想定）で、ブラウザ側が Workers の API を呼び出す構成です。ただし認証トークンは Worker が受け取って HttpOnly Cookie をセットするフローも混在しています（安全性向上のため）。

---

**重要ポイント（上から順にチェックすれば OK）**

| 項目 | どこを見る（ファイル/画面） | 何を確認するか | 期待される状態 |
|---|---|---|---|
| API 呼び出しの経路 | `admin-site/lib/api-client.ts` | `apiFetch()` が `credentials: 'include'` をセットしているか | `credentials: 'include'` と `redirect: 'manual'` がある |
| 認証（whoami） | `admin-site/app/admin/layout.tsx` の初期化処理 | ページ読み込み時に `/api/auth/whoami` を呼ぶ（クライアント） | 401 → 未認証／200 → ユーザ情報を返す |
| OAuth と Cookie 設定 | Cloudflare Worker (API proxy) の `/api/auth/*` ハンドラ | OAuth callback 経由で `Set-Cookie`（HttpOnly）を発行するか | OAuth 成功後に `Set-Cookie: sb-access-token=...` がレスポンスに含まれる |
| 画像表示（R2） | 画像URL の生成箇所：`admin-site` 内の `getPublicImageUrl` 等 | 画像が R2（または Cloudflare Images）経由で配信されるか | HEAD/GET が 200 を返し画像が表示される |
| 画像アップロード | `admin-site/components/image-upload.tsx` | `direct-upload` / `upload` / `complete` の API 呼び出しを行っているか | `apiFetch('/api/images/...')` で proxy or signed upload を実行する |
| 一貫性（fetch の統一） | リポジトリ全体で `fetch('/api` を検索 | 生の `fetch('/api'...)` が多く残っていないか | 管理向けは `apiFetch()` に統一されているのが望ましい |

---

## すぐできる確認手順（初心者向け・ブラウザ推奨）

1) ブラウザの DevTools を開いて「Network」タブを表示、`Disable cache` にチェック。

2) whoami のチェック（ブラウザ Console で貼り付け）

```js
fetch('/api/auth/whoami', { cache: 'no-store', credentials: 'include' })
  .then(async r => {
    console.log('status', r.status);
    const txt = await r.text();
    try { console.log(JSON.parse(txt)); } catch (e) { console.log('body', txt); }
  })
  .catch(e => console.error(e));
```
- 期待: ステータス `200` とユーザ情報（JSON）が返るならログイン済。`401` なら未認証。

3) OAuth の Set-Cookie チェック（実際にログインする）
- `/admin/login` から Google OAuth を実行。
- OAuth 後、DevTools の Network で `/api/auth/set_tokens` または `/api/auth/callback` のレスポンスを確認し、Response Headers に `Set-Cookie` が含まれていることを確認する（`sb-access-token` を含むこと）。

4) 画像配信チェック（PowerShell 例）
- 代表的な Cloudflare Image Delivery の URL（例）:

```powershell
# 例: account と id を環境に合わせて置き換えてください
curl.exe -I "https://imagedelivery.net/<ACCOUNT>/<IMAGE_ID>/public"
```
- 期待: `HTTP/1.1 200 OK` と `Content-Type: image/*` などが返る。
- もし `403` / `404` なら R2 に存在しないか、Cloudflare 側のアクセス制限が原因です。

5) Worker 経由で API が来ているか確認（PowerShell 例）
```powershell
curl.exe -v "https://admin.shirasame.com/api/auth/debug"
```
- 期待: Worker が受け取りレスポンスヘッダにプロキシ先表示（実装次第）。レスポンスが Worker 由来であれば Worker 側ログやヘッダが確認できます。

---

## よくある問題と簡単な対処

- whoami が `401` のまま
  - ブラウザの localStorage に古い `auth_user` が残っている場合がある。DevTools → Application → Local Storage で `auth_user` を削除して再読み込み。
  - OAuth の `Set-Cookie` が発行されていない場合は Worker の callback 設定（Domain / Path / SameSite / Secure）を見直す必要あり。

- 画像が表示されない（403/404）
  - まずは画像キーが R2 に存在するか（HEAD を打つ）を確認。存在しなければ再アップロードが必要。
  - Cloudflare Images の場合、Account ID と公開設定が正しいかを確認。

- 管理 UI が古い挙動をする（キャッシュ）
  - ハードリロード（Ctrl+F5）または DevTools の `Disable cache` を有効にして再読み込み。

---

## 「管理ページだけ見れば把握できる」チェックリスト（短縮版）
- 管理ページを開いて最初に見る場所:
  - 画面がすぐにユーザー名やメニューを表示しているか → 表示されるなら `whoami` は成功している可能性大
  - 画像のサムネイルが表示されるか → 表示されるなら R2/Images 経路は通っている
  - 画像アップロードを試して成功メッセージが出るか → 成功すれば upload→complete の API が動作している

---

## 次のステップ（私が代行できます）
- リポジトリ全体を走査して生の `fetch('/api'...)` を `apiFetch()` に一括置換して PR を作成します（自動で行います）。
- あなたが代表的な画像キーを教えてくれれば、私が HEAD を叩き存在確認（200/403/404）を行い原因を特定します。
- OAuth の Set-Cookie が来ていなければ、Worker の cookie 発行箇所（`Set-Cookie` 属性）を修正するパッチを提案します。

---

ファイルを作成しました: `docs/管理ページ_一目で理解.md`。
何を先に進めますか？（短く選んでください）
- A: fetch→apiFetch 一括置換を実行してください
- B: 代表の画像キーを調べて HEAD を叩いてください（私に調査させる）
- C: OAuth の E2E（ログイン→Set-Cookie）を一緒に確認したい（whoami の結果を貼ってください）

