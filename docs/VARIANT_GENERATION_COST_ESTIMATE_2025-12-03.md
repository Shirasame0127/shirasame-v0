---
title: Variant 生成コスト試算（オンプレ変換 vs CDN/Images 比較）
date: 2025-12-03
---

## 概要
このドキュメントは「variant（サムネイル・複数幅）を確実に生成して配る」ワークフローについて、想定トラフィック・保存数を基にしたコスト試算を示します。数値は明示した前提（Assumptions）に基づく推定値です。プロバイダの最新料金は必ず公式で確認してください。

## 前提（明確化）
- PV: **8000**（本試算では「月間 PV = 8000」を想定。もし日間 PV の意味であれば概算は 30 倍となります）
- アップロード頻度: 基本は **2日で1商品** を新規登録すると仮定。
- 最大登録商品数: **500 商品**（最終的に R2 に保存される画像数はこれを上限とします）
- 1 商品あたり画像枚数（新しい仮定）: **4 枚を想定**するが、実際は **全商品中70%** が4枚、**残り30%** は代表画像1枚のみと仮定する。→ 平均 **3.1 枚/商品**。
- 月間アップロード枚数（想定）: (30/2) * 3.1 = **約 46.5 ≒ 47 枚/月**
- 合計保存画像数 = **500 * 3.1 = 1,550 枚**
- 配信シナリオ（ページ当たりの初期画像数、ユーザ挙動）:
  - Collection 初期表示: 最大 **20 商品画像 + 1 ヘッダー（大） + レシピ画像数 ≒ 2** → 合計 **≈23 画像/ページ**
  - 全アイテム表示 / ギャラリーモード: 最初に **30 画像** を読み込む（以降スクロールで増える）
  - **40%** の PV が全アイテム表示／ギャラリーを利用すると仮定
- 画像バリアント（生成対象・確定）:
  - ヘッダー画像（大）: スマホ 800px / PC 800px（800px）
  - 商品画像（一覧表示）: スマホ 200px / PC 400px
  - 商品画像（詳細表示）: スマホ 400px / PC 400px（400px）
  - 添付画像（商品添付）: スマホ 200px / PC 400px
  - ギャラリー表示（商品画像＋添付混合）: スマホ 200px / PC 400px
  - レシピ画像: スマホ 400px / PC 800px
  - プロフィールアイコン: スマホ 200px / PC 200px（200px）
  - ローディングアニメーション用 GIF: オリジナルのまま（変換しない）
  - 他の公開ページに埋め込みの画像: オリジナルのまま（変換しない）

  要点: 実際に配信される主要な幅は `200px`, `400px`, `800px` に集約されます。変換パラメータを固定することで Cloudflare の "unique transformations" を抑制できます。
- 平均ファイルサイズ（変換後、ブラウザに最適化されたフォーマット想定）:
  - 200px: **25 KB**
  - 400px: **80 KB**
  - 800px: **180 KB**
  - 1600px: **350 KB**
  - オリジナル（アップロード）: **600 KB**（平均：高解像度写真想定）

## 配信リクエスト数の見積り
- 平均画像/ページ = 0.4 * 30 + 0.6 * 23 = 12 + 13.8 = **25.8 ≒ 26 画像/ページ**
- 月間画像配信リクエスト数 = `PV * 26` = **208,000 リクエスト/月**

### 変換サイズ分布（再仮定）
- 60% が 200px（モバイル中心）
- 30% が 400px
- 10% が 800px（デスクトップカード等）
 - ヘッダー等大判（1600px）はアクセス上の割合が非常に小さい想定のため本試算では除外（個別にカウントする場合は別途試算）

計算:
- 200px: 208,000 * 0.60 = 124,800 reqs → 124,800 * 25 KB = 3,120,000 KB = **≈3.05 GB**
- 400px: 208,000 * 0.30 = 62,400 reqs → 62,400 * 80 KB = 4,992,000 KB = **≈4.76 GB**
- 800px: 208,000 * 0.10 = 20,800 reqs → 20,800 * 180 KB = 3,744,000 KB = **≈3.57 GB**
- 1600px: 208,000 * 0.01 = 2,080 reqs → 2,080 * 350 KB = 728,000 KB = **≈0.69 GB**

- 合計月間転送量（概算）= **≈11.7 GB/月**
 合計月間転送量（概算）= **≈11.4 GB/月**

## 保存容量の見積り（variants を事前生成して R2 に保存する場合）
- ※ 過去の例は 1600px を含んでいました。今回の前提（大多数の製品画像は最大 800px まで）を元に再計算します。
- 1 枚あたり保存サイズ合計（original + 3 variants〔200/400/800〕） ≒ 600 KB + 180 KB + 80 KB + 25 KB = **約 885 KB ≒ 0.885 MB**

シナリオ別総保存容量（再計算）:
- 1,550 画像（500 商品 × 平均 3.1 枚） → 1,550 * 0.885 MB ≒ **約 1,371.8 MB ≒ 1.34 GB**
- 月間追加保存（アップロード 約 47 枚/月）: 47 * 0.885 MB ≒ **約 41.6 MB/月**

## コストモデル（Cloudflare 公式に合わせた再計算）
> 注: 2025-12-03 時点での Cloudflare ドキュメントに基づく公式に合わせて再計算します。実際の請求はアカウント・リージョン・契約によって変わるため、必ずプロバイダ請求で確認してください。

- 単価（Cloudflare 参考値）:
  - **R2 ストレージ（Paid）**: $0.015 / GB / 月（Free では 10 GB が無料）
  - **Cloudflare Images（Paid）**: $0.50 / 1,000 unique transformations（Free では最初の 5,000 unique transformations が含まれる）
  - **Cloudflare Images - Images Stored**: $5 / 100,000 images stored / 月（Paid の場合）
  - **Cloudflare Images - Images Delivered**: $1 / 100,000 images delivered / 月
  - **CDN（保守的参考）**: $0.10 / GB（Cloudflare Pages を利用する場合は実務上転送費が発生しないことが多いが保守的見積として併記）
  - **サーバー側変換（sharp）**: $0.02 / 画像（自己ホスティング / FaaS の CPU コスト目安）

上記に基づき、先の 3 つの戦略を再計算します（主に **最大 500 商品 = 1,550 画像（平均 3.1 枚/商品）** シナリオを例示）。

### 戦略 A — R2 にオリジナルのみ保存 + Cloudflare Image Resizing（オンデマンド変換）
- ストレージ: オリジナルのみ (600 KB/画像)
  - 保存容量シナリオ: 1k images => 0.6 GB, 10k => 6 GB, 50k => 30 GB
  - R2 の無料枠（10 GB）に収まる場合はストレージ費は **$0 /月**
- 転送: 実務上 Cloudflare Pages + R2 の組合せでは R2 -> エッジ配信における追加転送は発生しにくく、**$0 /月** となる場合が多い。保守的に外部 CDN 単価 $0.10/GB を当てると **$1.17 /月**。
- 変換リクエスト費: 変換は **unique transformation** 単位でカウントされ、Free では最初の 5,000 が無料。例えば 10k images * 4 variants = **40,000 unique transforms** と仮定した場合、課金対象は 40,000 - 5,000 = **35,000** → 35 * $0.50 = **$17.50 /月**。

計算例（ストレージ 10k 画像）:
- ストレージ: 6 GB → R2 free （10 GB）に収まるため **$0 /月**
- 転送: **$0 /月**（Cloudflare Pages 配信と仮定）
- 変換: **$17.50 /月**（40k unique transforms のうち 35k が課金対象）
- 合計（現実的） ≒ **$17.50 /月**

### 戦略 B — Cloudflare Images（マネージド）
Cloudflare Images を使う場合の主な課金項目は「Images Transformed（unique transformations）」「Images Stored」「Images Delivered」です。

計算例（ストレージ 10k 画像、40k unique transforms 想定）:
- Images Stored: 10,000 images → 10,000/100,000 * $5 = **$0.50 /月**
- Images Delivered: 208,000 delivered → 208,000/100,000 * $1 = **$2.08 /月**（Images に保存して配信する場合）
- Transforms: 40,000 - 5,000(free) = **35,000 billable** → 35 * $0.50 = **$17.50 /月**
- 合計 ≒ **$20.08 /月**（Images に格納して配信・変換した場合の概算）

### 戦略 C — 事前生成（sharp）で variants を全部 R2 に保存（配信は CDN 経由、変換は不要）
- ストレージ: variants 含めた総容量 (1.24 MB/画像)
  - 10k 画像 => 12.4 GB. R2 の無料枠は 10 GB までなので **2.4 GB が課金対象** → 2.4 * $0.015 = **$0.036 /月**
- 転送: Cloudflare 配信を利用する場合は **$0 /月** になり得る（保守的に $1.17 と見積ることも可能）
- 事前生成コスト: 75 画像/月 * $0.02/画像 = **$1.50 /月**（サーバー CPU コスト概算）
- 合計（現実的） ≒ **$1.54 /月**（R2 超過分 + 生成コスト。転送を無料と仮定）

## シナリオ比較テーブル（最大 500 商品 = 1,550 画像 想定、PV=8000/月）
| 戦略 | ストレージ費 | 転送費 | 変換/処理費 | 合計/月 (概算) |
|---|---:|---:|---:|---:|
| R2 + Image Resizing (オンデマンド) | $0.00 | $0.00 | $0.00 | $0.00 |
| Cloudflare Images (マネージド) | $0.08 | $2.08 | $0.00 | $2.16 |
| 事前生成（sharp）+ R2 variants | $0.00 | $0.00 | $0.94 | $0.94 |

> 注: 上記は概算で、単価や請求方法（帯域の地域別課金、Cloudflare プラン差、無料枠など）により変動します。請求は GB、リクエスト数、API 呼び出し数等の組合せとなるため、サービスの見積もりツールで再確認してください。

## UX（体験品質）比較（◎=最高、×=不可）
| 指標 | R2 + Image Resizing | Cloudflare Images | 事前生成 (sharp) |
|---|---:|---:|---:|
| 初回表示速度（エッジ変換） | ◎ | ◎ | 〇（最初の配信は CDN キャッシュ次第） |
| 一貫した品質（同一変換結果） | △（ブラウザ依存の auto-format が変動） | ◎ | ◎ |
| 即時反映（画像更新の反映確実性） | 〇（キャッシュキー次第） | ◎ | ◎ |
| GIF / アニメーション対応 | 〇（ルール次第） | ◎（管理機能あり） | ◎ |
| コストの安定性（長期） | ◎（低ストレージ） | 〇 | △（ストレージ増で上昇） |
| 実装負荷（運用） | ◎（軽い） | ◎（軽い） | △（サーバ管理要） |

解説:
- Cloudflare Images は「品質管理と変換の一貫性」が高く、アニメーションや署名付き配信などの管理機能が便利。運用負担は小さい。
- R2 + Image Resizing（オンデマンド）は最小の運用負荷で低コストだが、変換の細かいチューニングは限定される。自動フォーマットの振る舞いがブラウザやパラメータで変わるため「完全に同一のバイナリ」を望む用途には向かない。
- 事前生成は最も「出し先でのブレ」がなく確実だが、保存コストとアップロード処理（CPU）コストが増える。大規模ストレージになるとコスト差が顕著になる。

## 推奨（v0-samehome 向け）
1. 当面は **R2 にオリジナルを保存 + Cloudflare Image Resizing（オンデマンド）** を採用するのがバランスが良い。理由: Pages との親和性、sharp をデプロイ先に依存しない運用、転送量が想定値だと低額に収まるため。
2. もし「完全に同じ変換結果を常に返したい」「サムネイル一括生成をしておきたい」なら、**事前生成（sharp）** をバッチで回す運用を検討する。たとえば夜間バッチで未生成の variants を生成して R2 に保存する方法がよい。
3. Cloudflare Images は「管理の手間をもっと減らしたい」「署名付き配信や画像管理 UI を使いたい」場合に有力な選択肢。

## 次のアクション（提案）
- まずは `direct-upload` のレスポンスに `publicUrl` を追加してフロントで即時表示できるようにする（低リスク）
- Cloudflare 上で `Image Resizing` を有効にしてサンプル URL を作り、1 週間程度のヒット率と請求の挙動を観察する（運用データが最も信頼できる）
- 必要であれば夜間バッチで `sharp` を実行して既存画像の variants を pre-generate する手順を作る（将来のオプション）

---
※ この試算は入力値（PV、ファイルサイズ、単価）に敏感です。正確な請求を求める場合は上記の単価を実際のプロバイダ料金に差し替えてください。必要なら私の方で実プロバイダ料金を用いた再計算を行います。

## フリープラン（無料枠）を前提にした試算
公式ドキュメントを参照すると、Cloudflare の主要無料枠は概ね次の通りです（2025-12-03 時点のドキュメント情報）。

- **R2（無料枠）**: 標準ストレージ 10 GB / 月、Class A 操作（書き込み）1M、Class B 操作（読み取り）10M が無料枠に含まれる。
- **Cloudflare Images（Free）**: **5,000 unique transformations / 月** が無料で含まれる（超過後は Paid プランが必要）。
- **Cloudflare Pages（Free）**: 無料プランでサイトのビルド・配信・帯域が利用可能（Pages 自体に帯域課金は基本的に発生しない）。

上記を踏まえて、先の試算を無料枠に収めるための可否をシナリオ別に評価します。

### ケース A — 最大上限（500 商品 = 1,550 画像（平均 3.1 枚/商品））
- ストレージ (original only): 1,550 * 0.6 MB = **約 0.93 GB** → R2 の 10 GB 無料枠に余裕で収まる。
- 想定ユニーク変換数（商品画像のみで 3 variants と仮定）: 1,550 images * 3 variants = **4,650 unique transformations** → Cloudflare Images Free（5,000）に収まるため、変換課金は発生しない見込み。
- 月間配信トラフィック（先の分布比適用）: ≒11.4 GB → Cloudflare Pages + R2 の組合せでは転送の追加課金が発生しにくい（実務上は無料枠で収まる想定）。
 
 補強説明（初心者向け・かんたんまとめ）
 - 「R2 にオリジナルだけ置く」とは: 元のアップロード画像（600KB 想定）だけを保存しておき、表示時に必要があれば Cloudflare の Image Resizing がその場で小さなサイズを作って配る方式です。
 - なぜコストが安いのか（今回のケース）: 保存する容量が少なく（約 0.93 GB）、Image Resizing の「ユニーク変換」数も **4,650** と無料枠の **5,000** を下回るため、ストレージ料金も変換料金も発生しにくい構成です。
 - 「egress（出力/転送）無料」の意味: Cloudflare は R2 から Cloudflare のエッジ経由で配信する場合、外部クラウドへの通常の egress 料金を請求しない仕組みです。つまり Cloudflare の仕組み内で配る限り、転送で大きな追加料金は通常発生しません。ただし無料枠（10GB や 1M/10M の操作回数）を超えたり、特殊な外部ルートに流したりすると別途課金や注意が必要です。
 - パフォーマンス面（利用者が感じる速度）: 初回リクエストは Cloudflare 側で変換や R2 取得が行われるため少し遅くなる場合がありますが、一度エッジにキャッシュされると 2 回目以降は非常に速く配信されます（CDN の HIT が効く）。

 実務チェックリスト（すぐできる・初心者向け）
 - Cloudflare ダッシュボードで `R2 Storage` 使用量と `Class A / Class B` 操作数を確認する（無料枠に収まっているか確認）。
 - 代表的な画像 URL に対してヘッダ確認を実行し、`cf-cache-status` が `HIT` になるか試す（初回は `MISS`/`MISS` → 2 回目で `HIT` を期待）。
   - PowerShell 例:
     ```powershell
     Invoke-WebRequest -Method Head "https://<your-r2-subdomain>/path/to/object.jpg" -UseBasicParsing | Select-Object StatusCode,Headers
     ```
   - curl 例:
     ```bash
     curl -I https://<your-r2-subdomain>/path/to/object.jpg
     # レスポンスヘッダの `cf-cache-status` を確認
     ```
 - Image Resizing を使う場合は変換パラメータを固定（例: `width=200/400/800` のみ）して「ユニーク変換数」を抑える。
 - 人気の画像は事前生成しておく（上位 10–20%）と初回遅延を回避できる。

 短い結論: **今回の前提（1,550 画像 / 3 variants）では、R2 にオリジナル保存 + Image Resizing（オンデマンド）が最も手軽で安く、表示速度もキャッシュで十分速くなります。**

### ケース B — 事前生成（variants を全て R2 に保存）
- 保存容量（事前生成）: 1,550 画像 × 0.885 MB ≒ **約 1.34 GB** → R2 の 10 GB 無料枠に収まる。
- 事前生成コスト: 月間アップロード・生成分（約 47 画像/月 の処理）を想定すると、生成コストは概算で **$0.94 /月**（47 * $0.02）。

結論: 事前生成を採用した場合でも、最大 500 商品の前提では R2 の無料 10GB に収まりやすく、ストレージ課金は発生しにくい。変換ユニーク数の超過リスクを避けたいなら事前生成の部分導入が有効。

## 無料枠に収めるための実務的対策（チェックリスト）
- Cloudflare Images の **5,000 unique transformations/月** を超えないために:
  - 事前に代表的な variant（200/400/800/1600 等）を固定して URL にバリアントを埋め、**同じ変換パラメータ**を使い回してユニーク数を抑える。
  - 人気のある画像（上位 10-20%）は事前生成して R2 に保存し、残りはオンデマンド変換にする（ハイブリッド）。
  - 30 日スライドウィンドウの特性を利用し、頻繁にアクセスされる変換のみがカウントされる点を監視する。
- R2 無料 10 GB に収めるために:
  - Originals のみ保存する戦略を基本とする（事前生成は最小限に）。
  - 古い未使用画像のライフサイクル（TTL / 廃棄）を設定する。
- キャッシュヒット率を上げる:
  - 変換後の URL を適切にバージョニングして、ユーザー側・CDN 側のキャッシュヒット率を高める。
  - 画像の Cache-Control 運用を最適化する（長めの TTL とバージョニング併用）。

## 結論（無料運用の可否）
- **小規模（1k 画像・PV=8k）** なら無料枠内で運用可能な見込みが高い。
- **10k 程度のカタログ** だと R2 のストレージ無料枠は満たすが、Cloudflare Images の **5,000 unique transformations** を確実に超過するため、Images の有料化もしくは変換ユニーク数を抑える工夫が必要。

---
更新はここまでです。必要ならこの無料枠前提で「変換ユニーク数の見積りシミュレータ（CSV 入力で画像数・PV・variants を入れると、unique transformations と無料枠超過判定を出す簡易ツール）」を作成できます。続けますか？

