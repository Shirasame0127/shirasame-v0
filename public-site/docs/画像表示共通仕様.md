# 画像表示共通仕様

目的: 管理画面と公開ページで画像（アバター、ヘッダー、商品画像など）の取得・表示方法を共通化し、実装のぶれを防ぐ。

対象ユーティリティ（参照実装）
- `getPublicImageUrl(raw, domainOverride?)` — キーまたは URL を正規化して公開アクセス可能な URL を返す
- `buildResizedImageUrl(raw, { width, format?, quality? }, domainOverride?)` — 指定幅・形式の変換 URL を生成
- `responsiveImageForUsage(raw, usage, domainOverride?)` — 用途ごとに `src`/`srcSet`/`sizes` を生成
- `buildR2VariantFromBasePath(basePath, variant?)` / `buildR2VariantFromBasePathWithFormat(...)` — R2 のベースパスから throttled なバリアントを生成

基本フロー
- アップロード: フロント → `POST /api/images/upload` → (uploads 一時保存)
- 完了: `POST /api/images/complete` → レスポンスで `key` を受け取る
- 永続化: 得た `key` をユーザや商品レコードのフィールドに保存（例: `users.header_image_keys`）
- 表示: フロントは `getPublicImageUrl(key)` を呼び、必要に応じて `responsiveImageForUsage` / `buildResizedImageUrl` を使って `img.src` / `srcset` を設定

プレビューとローカルキャッシュ
- 編集 UI は `db.images.getUpload(key)` のマッピングを参照して、まだ公開 URL に反映されていないアップロード中のプレビューを表示する
- 保存完了後はサーバ側永続化を検証してから、ローカルキャッシュのみ更新する（管理 UI は `db.user.updateLocal(...)` を利用）

用途別ポリシー（推奨）
- avatar: `responsiveImageForUsage(raw, 'avatar')` → 小さめの幅（例: 48–128px）を中心に `srcSet` を準備
- list (カード一覧): `responsiveImageForUsage(raw, 'list')` → 中〜大の幅（例: 320–800px）
- recipe / detail: `responsiveImageForUsage(raw, 'recipe')` / `buildR2VariantFromBasePath(...,'detail-800')`
- header: `buildResizedImageUrl(key, { width: 800 })` を推奨

フォールバック/耐障害性
- `getPublicImageUrl` が null を返す場合は、受け取った raw を直接使う（もし `raw` が絶対 URL ならそのまま表示）
- `responsiveImageForUsage` の返り値が null/空のときはプレースホルダ画像を表示

実装上の注意
- 公開ページは必ず `getPublicImageUrl` / `responsiveImageForUsage` を経由して URL を生成すること（環境差分を隠蔽するため）
- R2 / CDN ドメインは `IMAGES_DOMAIN` 等の環境変数に依存するため、開発環境では相対パスでの扱いを考慮する
- 管理 UI はアップロード直後に余計な PUT（リソース書き換え）を出さないよう、サーバ保存直後はローカルキャッシュ更新に留める

参考実装ファイル
- `shared/lib/image-usecases.ts` — 参照実装（getPublicImageUrl / buildResizedImageUrl / responsiveImageForUsage）
- 管理画面呼び出し例: admin-site の `app/admin/settings/page.tsx`, `app/admin/products/edit/page.tsx`
- public-worker 側変換: public-worker/src/index.ts（headerImages の組み立てなど）

短い確認チェックリスト
- [ ] アップロード→complete→保存→getPublicImageUrl で表示が通る
- [ ] プレビューは `db.images.getUpload` を参照する
- [ ] `responsiveImageForUsage` を用途ごとに使い分けている
- [ ] 失敗時にプレースホルダを表示する

---
作業メモ: さらに詳細（具体的な関数シグネチャ、推奨幅テーブル、サンプルコード）を追加できます。必要なら続けて追加します。

**users を single-source にするプロファイル API（方針）**
- `/api/public/profile` は `users` テーブルの一行のみを参照し、公開ページのプロフィール情報を返す
- 返却するフィールド（例）:
	- `display_name`, `bio`, `profile_image_key`, `profile_image` (変換済 URL),
	- `header_image_keys`, `header_images` (変換済 URL 配列),
	- `background_type`, `background_value`, `social_links`
- フロントは raw key を直接使わず、`profile_image` / `header_images` のような変換済 URL を利用して表示する
- 既存の `/api/public/site-settings` は将来的に統合または廃止して、公開側の参照は `/api/public/profile` のみとする

推奨実装メモ:
- public-worker 側で `users` を取得後、`getPublicImageUrl` / `buildResizedImageUrl` を使って `profile_image` と `header_images` を組み立てて返却する
- 開発環境と本番環境の差は `IMAGES_DOMAIN` 等の env で吸収する

必要ならこのドキュメントに関数シグネチャと推奨幅テーブルを追加します。